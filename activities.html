<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Activities — English Papers</title>
  <link rel="stylesheet" href="css/main.css">

  <script>
    // Prevent flash if code stored
    if (localStorage.getItem('ubgHash')) {
      document.documentElement.classList.add('skip-gate');
    }
  </script>
  <style>
    #code-container { display:flex; }
    #app-content    { display:none; }
    .skip-gate #code-container { display:none!important; }
    .skip-gate #app-content    { display:block!important; }
  </style>
</head>
<body>
  <!-- Code Gate Overlay -->
  <div id="code-container">
    <div class="code-card">
      <h2>Enter Beta Key</h2>
      <div id="debug-code" style="font-size:0.9rem;color:var(--text-secondary);margin-bottom:0.5rem;"></div>
      <div class="letter-inputs">
        <input maxlength="1"><input maxlength="1">
        <input maxlength="1"><input maxlength="1">
        <input maxlength="1"><input maxlength="1">
      </div>
      <button id="confirm-btn">Confirm</button>
      <div id="code-message"></div>
    </div>
  </div>

  <!-- Page Content -->
  <header>
    <nav><a href="index.html">Home</a> | <a href="activities.html">Activities</a></nav>
  </header>
  
  <main id="app-content">
	<div class="warning-banner">⚠️ Anything typed into search bar may be flagged by content filtering software ⚠️</div>
    <div id="search-container" class="search-bar"></div>
    <div id="activities-container" class="activities-grid"></div>
  </main>

  <!-- Gate Logic & Dynamic Script Injection -->
<script>
    const titles = [
      "Mastering Grammar Essentials",
      "Exploring Shakespeare's World",
      "Top Tips for Better Writing",
      "Understanding English Literature",
      "Punctuation Rules You Need to Know",
      "How to Analyse a Poem",
      "Common English Mistakes and Fixes",
      "A Guide to Creative Writing",
      "The Power of Persuasive Language",
      "Unlocking English Vocabulary"
    ];
    document.title = titles[Math.floor(Math.random() * titles.length)];
  </script>
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const overlay    = document.getElementById('code-container');
    const debug      = document.getElementById('debug-code');
    const app        = document.getElementById('app-content');
    const inputs     = Array.from(overlay.querySelectorAll('input'));
    const btn        = document.getElementById('confirm-btn');
    const msg        = document.getElementById('code-message');
    const unlocked   = document.documentElement.classList.contains('skip-gate');

    // Debug stored code
    const storedCode = localStorage.getItem('ubgHash');
    if (storedCode) debug.textContent = `Stored: ${storedCode}`;

    // Auto-advance & backspace
    inputs.forEach((inp,i) => {
      inp.addEventListener('input', () => {
        inp.value = inp.value.replace(/[^A-Za-z0-9]/g,'').toUpperCase();
        if (inp.value && i < inputs.length-1) inputs[i+1].focus();
      });
      inp.addEventListener('keydown', e => {
        if (e.key==='Backspace' && !inp.value && i>0) inputs[i-1].focus();
      });
    });
    inputs[0].focus();

    const setMsg = t => msg.textContent = t;

    async function sha256hex(str){
      const buf = new TextEncoder().encode(str);
      const hash = await crypto.subtle.digest('SHA-256', buf);
      return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');
    }

    async function verify(code){
      setMsg('Checking…');
      try {
        const h   = await sha256hex(code);
        const txt = await fetch('https://services.englishpapers.org/urls/ubg_allowed.txt').then(r=>r.text());
        const ok  = txt.split('\n').map(l=>l.trim()).includes(h);
        return ok;
      } catch (e) {
        console.error("[Activities] Verify error:", e);
        setMsg('Error');
        return false;
      }
    }

    async function unlock(code){
      localStorage.setItem('ubgHash', code);
      document.documentElement.classList.add('skip-gate');
      overlay.style.display = 'none';
      app.style.display     = 'block';
      // inject activities.js
      const s = document.createElement('script');
      s.src = 'js/activities.js';
      document.body.appendChild(s);
    }

    async function handleConfirm(){
      const code = inputs.map(i=>i.value).join('');
      if(code.length<6) return setMsg('Enter 6 letters');
      btn.disabled=true; inputs.forEach(i=>i.value=''); setMsg(''); btn.style.display='none';
      const spinner = document.createElement('div'); spinner.className='spinner';
      overlay.querySelector('.code-card').insertBefore(spinner,msg);

      const [ok] = await Promise.all([
        verify(code),
        new Promise(r=>setTimeout(r,2000))
      ]);
      spinner.remove(); btn.style.display=''; btn.disabled=false;

      if(ok) unlock(code);
      else setMsg('Invalid code');
    }

    btn.addEventListener('click', handleConfirm);
    inputs.forEach(inp=>inp.addEventListener('keydown',e=>{
      if(e.key==='Enter') handleConfirm();
    }));

    if(unlocked){
      const s = document.createElement('script');
      s.src = 'js/activities.js';
      document.body.appendChild(s);
    }
  });
  </script>
</body>
</html>
